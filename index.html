<!DOCTYPE html>
<html>
<head>
	
	<title>Quick Start - Leaflet</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>

  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js" crossorigin=""></script>
  <script src="https://unpkg.com/georaster"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet/georaster-layer-for-leaflet.browserify.min.js"></script>

  <style>

  	#map {
  		position: static !important;
  	}

  	.options-container {
  		position: absolute;
	    right: 15px;
	    top: 15px;
	    padding: 5px;
	    z-index: 500;
	    background: #eeeeeecc;
  	}

  	.options-container p {
  		display: inline;
      user-select: none;
  	}

    .options-container input:enabled {
      cursor: pointer;
    }

    .options-container input:disabled {
      cursor: not-allowed;
    }

    .options-container input:disabled::hover

  </style>
	
</head>
<body>

	<div class=options-container>
		<input type="checkbox" id="marker-toggle"><p>Hospital Markers</p>
    <br />
    <input type="checkbox" id="floodmap-toggle"><p>Flood Map</p>
    <!-- <input type="checkbox" id="floodmap-toggle" title="Loading..." disabled><p>Flood Map</p> -->
	</div>
	<div id="map" style="width: 100vw; height: 100vh;"></div>
	<script>

		const mymap = L.map('map').setView([8, 81], 7);

		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
				'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
			id: 'mapbox.streets'
		}).addTo(mymap);
    
    const floodMapLayer = L.tileLayer('https://storage.googleapis.com/c2s_developer_exercise/SentinelCombo_20180516_20180612/{z}/{x}/{y}.png');

		const hospitalLayer = new L.GeoJSON.AJAX('https://storage.googleapis.com/c2s_developer_exercise/sri-lanka_hospitals_osm.geojson', { onEachFeature: onEachFeature });

		// hospitalLayer.addTo(mymap);

		const properties = ['addr_city', 'addr_full', 'addr_house', 'addr_stree', 'amenity', 'beds', 'man_made', 'opening_ho', 'osm_id', 'rooms', 'shop', 'tourism'];

		function onEachFeature(feature, layer) {
			let popupContent = `<p>NAME: ${feature.properties.name}</p>`;
			properties.forEach(property => {
				const propertyValue = feature.properties[property];
				if (!propertyValue) {
					return;
				}
				popupContent += `<p>${property}: ${propertyValue}</p>`;
			})

			layer.bindPopup(popupContent);
		};


		const url_to_geotiff_file = "https://storage.googleapis.com/c2s_developer_exercise/SentinelCombo_20180516_20180612.tif";

    let floodLayer;

		fetch(url_to_geotiff_file)
		  .then(response => {
        return response.arrayBuffer();
      })
		  .then(arrayBuffer => {
		    parseGeoraster(arrayBuffer).then(georaster => {
		      console.log("georaster:", georaster);

		      /*
		          GeoRasterLayer is an extension of GridLayer,
		          which means can use GridLayer options like opacity.

		          Just make sure to include the georaster option!

		          Optionally set the pixelValuesToColorFn function option to customize
		          how values for a pixel are translated to a color.

		          http://leafletjs.com/reference-1.2.0.html#gridlayer
		      */
		      floodLayer = new GeoRasterLayer({
		          georaster: georaster,
		          opacity: 0.7,
		          pixelValuesToColorFn: values => values[0] === 42 ? '#ffffff' : '#000000',
		          resolution: 64 // optional parameter for adjusting display resolution
		      });

          // enable and remove Loading tooltip from toggle now that layer is accessible
          floodmapToggle.disabled = false;
          floodmapToggle.removeAttribute('title');
		  });
		});


    const markerToggle = document.getElementById('marker-toggle');
    markerToggle.onchange = e => {
    	if (e.target.checked) {
    		mymap.addLayer(hospitalLayer);
    	} else {
    		mymap.removeLayer(hospitalLayer);
    	}
    };
    
    const floodmapToggle = document.getElementById('floodmap-toggle');
    floodmapToggle.onchange = e => {
      if (e.target.checked) {
        mymap.addLayer(floodMapLayer);
      } else {
        mymap.removeLayer(floodMapLayer);
      }
    };
	</script>
	</body>
</html>
